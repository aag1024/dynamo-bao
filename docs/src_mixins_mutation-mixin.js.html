<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link type="text/css" rel="stylesheet" href="jsdoc.css"><title>Source: src/mixins/mutation-mixin.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><style>.gh-button-container{position:fixed;top:20px;right:200px;z-index:100}</style><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">DynamoBao</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-01-model-definitions.html">Model Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-02-query-and-filter.html">Querying and Filtering</a></div><div class="sidebar-section-children"><a href="tutorial-04-changing-models.html">Modifying Models</a></div><div class="sidebar-section-children"><a href="tutorial-05-ttl-fields.html">Time-to-live (TTL) Fields</a></div><div class="sidebar-section-children"><a href="tutorial-06-custom-fields.html">Custom Fields</a></div><div class="sidebar-section-children"><a href="tutorial-07-command-line-tools.html">Command Line Tools</a></div><div class="sidebar-section-children"><a href="tutorial-08-multi-tenancy.html">Multi-Tenancy</a></div><div class="sidebar-section-children"><a href="tutorial-09-cloudflare-workers.html">Cloudflare Workers</a></div><div class="sidebar-section-children"><a href="tutorial-10-batch-context-configuration.html">Batch Context Configuration</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoFields.html">BaoFields</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoError.html">BaoError</a></div><div class="sidebar-section-children"><a href="BaoFields.BaoBaseField.html">BaoBaseField</a></div><div class="sidebar-section-children"><a href="BaoFields.BinaryField.html">BinaryField</a></div><div class="sidebar-section-children"><a href="BaoFields.BooleanField.html">BooleanField</a></div><div class="sidebar-section-children"><a href="BaoFields.CounterField.html">CounterField</a></div><div class="sidebar-section-children"><a href="BaoFields.CreateDateField.html">CreateDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.DateTimeField.html">DateTimeField</a></div><div class="sidebar-section-children"><a href="BaoFields.FloatField.html">FloatField</a></div><div class="sidebar-section-children"><a href="BaoFields.IntegerField.html">IntegerField</a></div><div class="sidebar-section-children"><a href="BaoFields.ModifiedDateField.html">ModifiedDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.RelatedField.html">RelatedField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringField.html">StringField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringSetField.html">StringSetField</a></div><div class="sidebar-section-children"><a href="BaoFields.TtlField.html">TtlField</a></div><div class="sidebar-section-children"><a href="BaoFields.UlidField.html">UlidField</a></div><div class="sidebar-section-children"><a href="BaoFields.VersionField.html">VersionField</a></div><div class="sidebar-section-children"><a href="BaoModel.html">BaoModel</a></div><div class="sidebar-section-children"><a href="ConditionalError.html">ConditionalError</a></div><div class="sidebar-section-children"><a href="ConfigurationError.html">ConfigurationError</a></div><div class="sidebar-section-children"><a href="DataFormatError.html">DataFormatError</a></div><div class="sidebar-section-children"><a href="FilterExpressionBuilder.html">FilterExpressionBuilder</a></div><div class="sidebar-section-children"><a href="ItemNotFoundError.html">ItemNotFoundError</a></div><div class="sidebar-section-children"><a href="ObjectNotFound.html">ObjectNotFound</a></div><div class="sidebar-section-children"><a href="QueryError.html">QueryError</a></div><div class="sidebar-section-children"><a href="TenantContext.html">TenantContext</a></div><div class="sidebar-section-children"><a href="ValidationError.html">ValidationError</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="https://github.com/aag1024/dynamo-bao" target="_blank">ðŸ”— Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/dynamo-bao" target="_blank">ðŸ“¦ NPM</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">src_mixins_mutation-mixin.js</h1></header><article><pre class="prettyprint source lang-js"><code>const {
  TransactWriteCommand,
  UpdateCommand,
  DeleteCommand,
} = require("../dynamodb-client");
const { defaultLogger: logger } = require("../utils/logger");
const { pluginManager } = require("../plugin-manager");
const { retryOperation } = require("../utils/retry-helper");
const assert = require("assert");
const { FilterExpressionBuilder } = require("../filter-expression");
const {
  ItemNotFoundError,
  ConditionalError,
  ValidationError,
} = require("../exceptions");

const MutationMethods = {
  /**
   *@memberof BaoModel
   * @description
   * Create a new item in the database.
   * @param {Object} jsUpdates - The data to create the item with.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the created item.
   */
  async create(jsUpdates) {
    await pluginManager.executeHooks(this.name, "beforeSave", jsUpdates, {
      isNew: true,
    });
    const result = await this._saveItem(null, jsUpdates, { isNew: true });

    logger.debug("create() - result", result);
    await pluginManager.executeHooks(this.name, "afterSave", result, {
      isNew: true,
    });
    return result;
  },

  /**
   *@memberof BaoModel
   * @description
   * Update an existing item in the database.
   * @param {string} primaryId - The primary ID of the item to update.
   * @param {Object} jsUpdates - The data to update the item with.
   * @param {Object} [options] - Additional options for the update operation.
   * @param {Object} [options.condition] - Condition that must be met for the update to succeed.
   *   The condition supports the same operators as filter expressions:
   *   - Simple field comparisons: { fieldName: value } for exact matches
   *   - Comparison operators: { fieldName: { $eq: value, $ne: value, $gt: value, $gte: value, $lt: value, $lte: value } }
   *   - String operators: { fieldName: { $beginsWith: value, $contains: value } }
   *   - Existence check: { fieldName: { $exists: true|false } }
   *   - Logical operators: $and, $or, $not
   * @param {boolean} [options.forceReindex=false] - When true, repopulates all index attributes even if the source fields are unchanged.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the updated item.
   * @throws {Error} "Item not found" if the item doesn't exist
   * @throws {Error} "Condition check failed" if the condition isn't satisfied
   */
  async update(primaryId, jsUpdates, options = {}) {
    const updateOptions = {
      isNew: false,
      ...options,
    };

    await pluginManager.executeHooks(
      this.name,
      "beforeSave",
      jsUpdates,
      updateOptions,
    );

    const result = await this._saveItem(primaryId, jsUpdates, updateOptions);

    logger.debug("update() - result", result);

    await pluginManager.executeHooks(
      this.name,
      "afterSave",
      result,
      updateOptions,
    );

    return result;
  },

  /**
   *@memberof BaoModel
   * @description
   * Delete an existing item in the database.
   * @param {string} primaryId - The primary ID of the item to delete.
   * @param {Object} [options] - Additional options for the delete operation.
   * @param {Object} [options.condition] - Condition that must be met for the delete to succeed.
   *   The condition supports the same operators as filter expressions:
   *   - Simple field comparisons: { fieldName: value } for exact matches
   *   - Comparison operators: { fieldName: { $eq: value, $ne: value, $gt: value, $gte: value, $lt: value, $lte: value } }
   *   - String operators: { fieldName: { $beginsWith: value, $contains: value } }
   *   - Existence check: { fieldName: { $exists: true|false } }
   *   - Logical operators: $and, $or, $not
   * @example
   * // Delete with simple condition
   * await Model.delete(id, {
   *   condition: { status: 'active' }
   * });
   *
   * // Delete with complex condition
   * await Model.delete(id, {
   *   condition: {
   *     $and: [
   *       { status: { $exists: true } },
   *       { age: { $gt: 21 } }
   *     ]
   *   }
   * });
   * @throws {Error} "Item not found" if the item doesn't exist
   * @throws {Error} "Delete condition not met" if the condition isn't satisfied
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the deleted item.
   */
  async delete(primaryId, options = {}) {
    await pluginManager.executeHooks(
      this.name,
      "beforeDelete",
      primaryId,
      options,
    );

    const item = await this.find(primaryId, { batchDelay: 0 });
    if (!item.exists()) {
      throw new ItemNotFoundError("Item not found", primaryId);
    }

    // Check if we need to clean up any unique constraints
    const uniqueConstraints = Object.values(this.uniqueConstraints || {});
    const hasConstraintsToClean = uniqueConstraints.some((constraint) => {
      const value = item[constraint.field];
      return value != null;
    });

    try {
      let response;

      if (hasConstraintsToClean) {
        // Transaction path - handle unique constraint cleanup
        const transactItems = [
          {
            Delete: {
              TableName: this.table,
              Key: {
                _pk: item._dyData._pk,
                _sk: item._dyData._sk,
              },
            },
          },
        ];

        // Add condition if specified
        if (options.condition) {
          const builder = new FilterExpressionBuilder();
          const filterExpression = builder.build(options.condition, this);

          if (filterExpression) {
            transactItems[0].Delete = {
              ...transactItems[0].Delete,
              ConditionExpression: filterExpression.FilterExpression,
              ExpressionAttributeNames:
                filterExpression.ExpressionAttributeNames,
              ExpressionAttributeValues:
                filterExpression.ExpressionAttributeValues,
            };
          }
        }

        // Add unique constraint cleanup operations
        for (const constraint of uniqueConstraints) {
          const value = item[constraint.field];
          if (value) {
            const constraintOp = await this._removeUniqueConstraint(
              constraint.field,
              value,
              item.getPrimaryId(),
              constraint.constraintId,
            );
            transactItems.push(constraintOp);
          }
        }

        response = await retryOperation(() =>
          this.documentClient.send(
            new TransactWriteCommand({
              TransactItems: transactItems,
              ReturnConsumedCapacity: "TOTAL",
            }),
          ),
        );
      } else {
        // Fast path - simple delete
        const deleteParams = {
          TableName: this.table,
          Key: {
            _pk: item._dyData._pk,
            _sk: item._dyData._sk,
          },
          ReturnValues: "ALL_OLD",
          ReturnConsumedCapacity: "TOTAL",
        };

        // Add condition if specified
        if (options.condition) {
          const builder = new FilterExpressionBuilder();
          const filterExpression = builder.build(options.condition, this);

          if (filterExpression) {
            deleteParams.ConditionExpression =
              filterExpression.FilterExpression;
            deleteParams.ExpressionAttributeNames =
              filterExpression.ExpressionAttributeNames;
            deleteParams.ExpressionAttributeValues =
              filterExpression.ExpressionAttributeValues;
          }
        }

        response = await retryOperation(() =>
          this.documentClient.send(new DeleteCommand(deleteParams)),
        );
      }

      await pluginManager.executeHooks(
        this.name,
        "afterDelete",
        primaryId,
        options,
      );

      // For transaction path, we already have the item
      // For fast path, we get it from the response
      const deletedItem = hasConstraintsToClean
        ? item
        : this._createFromDyItem(response.Attributes);
      deletedItem._setConsumedCapacity(
        response.ConsumedCapacity,
        "write",
        false,
      );

      return deletedItem;
    } catch (error) {
      if (
        error.name === "ConditionalCheckFailedException" ||
        (error.name === "TransactionCanceledException" &amp;&amp;
          error.CancellationReasons?.[0]?.Code === "ConditionalCheckFailed")
      ) {
        throw new ConditionalError(
          "Delete condition not met",
          "delete",
          options.condition,
        );
      }
      throw error;
    }
  },

  _createNewPrimaryId(jsUpdates) {
    // Now calculate primary key values using the processed data
    const pkValue = this._getPkValue(jsUpdates);
    const skValue = this._getSkValue(jsUpdates);

    // Format the primary key
    const pk = this._formatPrimaryKey(this.modelPrefix, pkValue);
    const primaryId = this.getPrimaryId({
      ...jsUpdates,
      _pk: pk,
      _sk: skValue,
    });

    return primaryId;
  },

  /**
   *@memberof BaoModel
   * @private
   * @description
   * Save an item to the database.
   * @param {string} primaryId - The primary ID of the item to save.
   * @param {Object} jsUpdates - The data to save the item with.
   * @param {Object} [options] - Additional options for the save operation.
   * @param {boolean} [options.isNew=false] - Whether this is a new item being created. Internal use only.
   * @param {Object} [options.instanceObj=null] - Existing model instance, if any. Internal use only.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the saved item.
   */
  async _saveItem(primaryId, jsUpdates, options = {}) {
    try {
      const {
        isNew = false,
        instanceObj = null,
        forceReindex = false,
      } = options;

      logger.debug("saveItem", primaryId, isNew, instanceObj);
      let consumedCapacity = [];

      let currentItem = instanceObj;
      if (isNew) {
        currentItem = null;
      } else if (!currentItem) {
        currentItem = await this.find(primaryId, { batchDelay: 0 });
        if (currentItem &amp;&amp; currentItem.exists()) {
          consumedCapacity = [
            ...consumedCapacity,
            ...currentItem.getConsumedCapacity(),
          ];
        } else {
          throw new ItemNotFoundError("Item not found", primaryId);
        }
      }

      if (!isNew &amp;&amp; !currentItem) {
        throw new ItemNotFoundError("Item not found", primaryId);
      }

      const transactItems = [];
      const dyUpdatesToSave = {};
      const indexComputationData = {};
      let hasUniqueConstraintChanges = false;

      logger.debug("jsUpdates", jsUpdates);

      // Generate Dynamo Updates to save
      for (const [key, field] of Object.entries(this.fields)) {
        if (isNew &amp;&amp; jsUpdates[key] === undefined) {
          // Only set initial values during creation
          const initialValue = field.getInitialValue();
          if (initialValue !== undefined) {
            jsUpdates[key] = initialValue;
          }
        }

        if (jsUpdates[key] !== undefined) {
          field.validate(jsUpdates[key]);
          const dyValue = field.toDy(jsUpdates[key]);
          dyUpdatesToSave[key] = dyValue;
          indexComputationData[key] = dyValue;
        } else {
          if (typeof field.updateBeforeSave === "function") {
            const newValue = field.updateBeforeSave(jsUpdates[key]);
            if (newValue !== jsUpdates[key]) {
              const dyValue = field.toDy(newValue);
              dyUpdatesToSave[key] = dyValue;
              indexComputationData[key] = dyValue;
            }
          }
        }
      }

      if (forceReindex &amp;&amp; currentItem) {
        Object.keys(this.fields).forEach((fieldName) => {
          const currentValue = currentItem._dyData[fieldName];
          if (currentValue !== undefined) {
            indexComputationData[fieldName] = currentValue;
          }
        });
      }

      if (isNew) {
        primaryId = this._createNewPrimaryId(jsUpdates);

        // validate required fields
        for (const [fieldName, field] of Object.entries(this.fields)) {
          if (
            field.required &amp;&amp;
            (jsUpdates[fieldName] === undefined ||
              jsUpdates[fieldName] === null)
          ) {
            throw new ValidationError(
              `Field is required: ${fieldName}`,
              fieldName,
              jsUpdates[fieldName],
            );
          }
        }
      }

      Object.entries(jsUpdates).forEach(([fieldName, value]) => {
        const field = this._getField(fieldName);
        if (field) {
          field.validate(value, fieldName);
        }
      });

      // Validate unique constraints before attempting save
      await this._validateUniqueConstraints(
        jsUpdates,
        isNew ? null : primaryId,
      );

      // Handle unique constraints
      for (const constraint of Object.values(this.uniqueConstraints || {})) {
        const fieldName = constraint.field;
        const field = this._getField(fieldName);
        const dyNewValue = dyUpdatesToSave[fieldName];
        const dyCurrentValue = currentItem?._loadedDyData[fieldName];

        logger.debug("uniqueConstraint", field, dyCurrentValue, dyNewValue);

        if (dyNewValue !== undefined &amp;&amp; dyNewValue !== dyCurrentValue) {
          hasUniqueConstraintChanges = true;

          // Remove old constraint if updating
          if (currentItem &amp;&amp; dyCurrentValue) {
            transactItems.push(
              await this._removeUniqueConstraint(
                fieldName,
                dyCurrentValue,
                primaryId,
                constraint.constraintId,
              ),
            );
          }

          // Add new constraint
          transactItems.push(
            await this._createUniqueConstraint(
              fieldName,
              dyNewValue,
              primaryId,
              constraint.constraintId,
            ),
          );
        }
      }

      // Add GSI keys
      const indexSourceData =
        forceReindex &amp;&amp; Object.keys(indexComputationData).length
          ? indexComputationData
          : dyUpdatesToSave;

      const indexKeys = this._getIndexKeys(indexSourceData);
      logger.debug("indexKeys", indexKeys);
      Object.assign(dyUpdatesToSave, indexKeys);

      // Add iteration keys if model is iterable
      if (this.iterable) {
        const iterationKeys = this._getIterationKeys(
          primaryId,
          dyUpdatesToSave,
        );
        Object.assign(dyUpdatesToSave, iterationKeys);
      }

      // Build the update expression first
      const { updateExpression, names, values } = this._buildUpdateExpression(
        dyUpdatesToSave,
        currentItem,
      );

      // Create the base update params
      const updateParams = {
        TableName: this.table,
        Key: this._getDyKeyForPkSk(this._parsePrimaryId(primaryId)),
        UpdateExpression: updateExpression,
        ReturnValues: "ALL_NEW",
      };

      if (Object.keys(names).length > 0) {
        updateParams.ExpressionAttributeNames = {
          ...names,
        };
      }

      if (Object.keys(values).length > 0) {
        updateParams.ExpressionAttributeValues = {
          ...values,
        };
      }

      // Build the condition expression for the update/put
      const conditionExpressions = [];
      const conditionNames = {};
      const conditionValues = {};

      if (options.condition) {
        const builder = new FilterExpressionBuilder();
        const filterExpression = builder.build(options.condition, this);

        if (filterExpression) {
          updateParams.ConditionExpression = filterExpression.FilterExpression;
          updateParams.ExpressionAttributeNames = {
            ...updateParams.ExpressionAttributeNames,
            ...filterExpression.ExpressionAttributeNames,
          };
          updateParams.ExpressionAttributeValues = {
            ...updateParams.ExpressionAttributeValues,
            ...filterExpression.ExpressionAttributeValues,
          };
        }
      } else if (isNew) {
        // For new items, ensure they don't already exist
        updateParams.ConditionExpression = "attribute_not_exists(#pk)";
        updateParams.ExpressionAttributeNames = {
          ...updateParams.ExpressionAttributeNames,
          "#pk": "_pk",
        };
      }

      const dyKey = this._getDyKeyForPkSk(this._parsePrimaryId(primaryId));
      logger.debug("dyKey", dyKey);

      try {
        let response;

        if (hasUniqueConstraintChanges) {
          // Use transaction if we have unique constraint changes
          transactItems.push({
            Update: updateParams,
          });

          logger.debug("transactItems", JSON.stringify(transactItems, null, 2));

          response = await retryOperation(() =>
            this.documentClient.send(
              new TransactWriteCommand({
                TransactItems: transactItems,
                ReturnConsumedCapacity: "TOTAL",
              }),
            ),
          );

          logger.debug("transactItems response", response);
          logger.debug("primaryId to load", primaryId);

          // Fetch the item since transactWrite doesn't return values
          const savedItem = await this.find(primaryId, { batchDelay: 0 });

          logger.debug("savedItem", savedItem);
          logger.debug("savedItem.getPrimaryId()", savedItem.getPrimaryId());

          if (!savedItem.exists()) {
            throw new ConditionalError("Failed to fetch saved item", "update");
          }

          // Set the consumed capacity from the transaction
          savedItem._addConsumedCapacity(
            response.ConsumedCapacity,
            "write",
            false,
          );
          savedItem._addConsumedCapacity(consumedCapacity, "read", false);

          return savedItem;
        } else {
          // Use simple update if no unique constraints are changing
          logger.debug("updateParams", JSON.stringify(updateParams, null, 2));

          try {
            response = await retryOperation(() =>
              this.documentClient.send(
                new UpdateCommand({
                  ...updateParams,
                  ReturnConsumedCapacity: "TOTAL",
                }),
              ),
            );
          } catch (error) {
            logger.error(`DynamoDB update failed for ${primaryId}:`, error);
            throw error;
          }

          const savedItem = this._createFromDyItem(response.Attributes);
          logger.debug("savedItem", savedItem);

          savedItem._setConsumedCapacity(
            response.ConsumedCapacity,
            "write",
            false,
          );
          savedItem._addConsumedCapacity(consumedCapacity, "read", false);

          if (!savedItem.exists()) {
            throw new ConditionalError("Failed to fetch saved item", "update");
          }

          return savedItem;
        }
      } catch (error) {
        logger.error("Error in _saveItem", error);
        if (error.name === "ConditionalCheckFailedException") {
          throw new ConditionalError("Condition check failed", "update", error);
        }

        if (error.name === "TransactionCanceledException") {
          // Check if it's due to conditional check failure
          if (
            error.CancellationReasons?.some(
              (reason) => reason.Code === "ConditionalCheckFailed",
            )
          ) {
            throw new ConditionalError(
              "Transaction cancelled due to condition check failure",
              "update",
              error,
            );
          }
          // For other transaction cancellation reasons, try to validate unique constraints
          // which will throw the appropriate ConditionalError if that's the issue
          await this._validateUniqueConstraints(
            jsUpdates,
            isNew ? null : primaryId,
          );
        }
        throw error;
      }
    } catch (error) {
      logger.error(`Error in _saveItem for ${primaryId}:`, error);
      throw error;
    }
  },

  _buildUpdateExpression(dyUpdatesToSave, currentItem = null) {
    const names = {};
    const values = {};
    const expressions = [];

    logger.debug("dyUpdatesToSave", dyUpdatesToSave);

    // Process all fields in the data
    for (const [fieldName, value] of Object.entries(dyUpdatesToSave)) {
      // Skip undefined values
      if (value === undefined) continue;

      const field = this._getField(fieldName);

      // Handle null values differently - use REMOVE instead of SET
      if (value === null) {
        expressions.push({
          type: "REMOVE",
          expression: `#${fieldName}`,
          attrNameKey: `#${fieldName}`,
          fieldName: fieldName,
          fieldValue: null,
        });
      } else {
        // For StringSetField, pass the original value for diffing
        const { StringSetFieldClass } = require("../fields");
        if (field instanceof StringSetFieldClass &amp;&amp; currentItem) {
          const originalValue = currentItem._loadedDyData[fieldName];
          const updateExpression = field.getUpdateExpression(
            fieldName,
            value,
            originalValue,
          );

          // Handle ADD_DELETE operations (multiple operations for the same field)
          if (updateExpression &amp;&amp; updateExpression.type === "ADD_DELETE") {
            expressions.push(...updateExpression.operations);
          } else if (updateExpression) {
            expressions.push(updateExpression);
          }
        } else {
          const updateExpression = field.getUpdateExpression(fieldName, value);
          if (updateExpression) {
            expressions.push(updateExpression);
          }
        }
      }
    }

    const parts = [];
    const setExpressions = [];
    const addExpressions = [];
    const removeExpressions = [];
    const deleteExpressions = [];

    expressions.forEach((expression) => {
      if (expression.type === "SET") {
        setExpressions.push(expression.expression);
      } else if (expression.type === "ADD") {
        addExpressions.push(expression.expression);
      } else if (expression.type === "REMOVE") {
        removeExpressions.push(expression.expression);
      } else if (expression.type === "DELETE") {
        deleteExpressions.push(expression.expression);
      }

      if (expression.attrNameKey) {
        names[expression.attrNameKey] = expression.fieldName;
      }

      if (expression.fieldValue !== null &amp;&amp; expression.attrValueKey) {
        values[expression.attrValueKey] = expression.fieldValue;
      }
    });

    if (setExpressions.length > 0)
      parts.push(`SET ${setExpressions.join(", ")}`);
    if (addExpressions.length > 0)
      parts.push(`ADD ${addExpressions.join(", ")}`);
    if (removeExpressions.length > 0)
      parts.push(`REMOVE ${removeExpressions.join(", ")}`);
    if (deleteExpressions.length > 0)
      parts.push(`DELETE ${deleteExpressions.join(", ")}`);

    return {
      updateExpression: parts.join(" "),
      names,
      values,
    };
  },

  _getIndexKeys(data) {
    const indexKeys = {};

    Object.entries(this.indexes).forEach(([indexName, index]) => {
      let pkValue, skValue;

      // Handle partition key
      if (index.pk === "modelPrefix") {
        pkValue = this.modelPrefix;
      } else {
        const pkField = this._getField(index.pk);
        pkValue = data[index.pk];
        if (pkValue !== undefined) {
          pkValue = pkField.toGsi(pkValue);
        }
      }

      // Handle sort key
      if (index.sk === "modelPrefix") {
        skValue = this.modelPrefix;
      } else {
        const skField = this._getField(index.sk);
        skValue = data[index.sk];
        if (skValue !== undefined) {
          skValue = skField.toGsi(skValue);
        }
      }

      if (
        pkValue !== undefined &amp;&amp;
        skValue !== undefined &amp;&amp;
        index.indexId !== undefined
      ) {
        logger.debug("indexKeys", {
          pkValue,
          skValue,
          indexId: index.indexId,
        });
        const gsiPk = this._formatGsiKey(
          this.modelPrefix,
          index.indexId,
          pkValue,
        );
        indexKeys[`_${index.indexId}_pk`] = gsiPk;
        indexKeys[`_${index.indexId}_sk`] = skValue;
      }
    });

    return indexKeys;
  },
};

module.exports = MutationMethods;
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">DynamoBao</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="https://github.com/aag1024/dynamo-bao" target="_blank">ðŸ”— Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/dynamo-bao" target="_blank">ðŸ“¦ NPM</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-01-model-definitions.html">Model Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-02-query-and-filter.html">Querying and Filtering</a></div><div class="sidebar-section-children"><a href="tutorial-04-changing-models.html">Modifying Models</a></div><div class="sidebar-section-children"><a href="tutorial-05-ttl-fields.html">Time-to-live (TTL) Fields</a></div><div class="sidebar-section-children"><a href="tutorial-06-custom-fields.html">Custom Fields</a></div><div class="sidebar-section-children"><a href="tutorial-07-command-line-tools.html">Command Line Tools</a></div><div class="sidebar-section-children"><a href="tutorial-08-multi-tenancy.html">Multi-Tenancy</a></div><div class="sidebar-section-children"><a href="tutorial-09-cloudflare-workers.html">Cloudflare Workers</a></div><div class="sidebar-section-children"><a href="tutorial-10-batch-context-configuration.html">Batch Context Configuration</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoFields.html">BaoFields</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoError.html">BaoError</a></div><div class="sidebar-section-children"><a href="BaoFields.BaoBaseField.html">BaoBaseField</a></div><div class="sidebar-section-children"><a href="BaoFields.BinaryField.html">BinaryField</a></div><div class="sidebar-section-children"><a href="BaoFields.BooleanField.html">BooleanField</a></div><div class="sidebar-section-children"><a href="BaoFields.CounterField.html">CounterField</a></div><div class="sidebar-section-children"><a href="BaoFields.CreateDateField.html">CreateDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.DateTimeField.html">DateTimeField</a></div><div class="sidebar-section-children"><a href="BaoFields.FloatField.html">FloatField</a></div><div class="sidebar-section-children"><a href="BaoFields.IntegerField.html">IntegerField</a></div><div class="sidebar-section-children"><a href="BaoFields.ModifiedDateField.html">ModifiedDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.RelatedField.html">RelatedField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringField.html">StringField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringSetField.html">StringSetField</a></div><div class="sidebar-section-children"><a href="BaoFields.TtlField.html">TtlField</a></div><div class="sidebar-section-children"><a href="BaoFields.UlidField.html">UlidField</a></div><div class="sidebar-section-children"><a href="BaoFields.VersionField.html">VersionField</a></div><div class="sidebar-section-children"><a href="BaoModel.html">BaoModel</a></div><div class="sidebar-section-children"><a href="ConditionalError.html">ConditionalError</a></div><div class="sidebar-section-children"><a href="ConfigurationError.html">ConfigurationError</a></div><div class="sidebar-section-children"><a href="DataFormatError.html">DataFormatError</a></div><div class="sidebar-section-children"><a href="FilterExpressionBuilder.html">FilterExpressionBuilder</a></div><div class="sidebar-section-children"><a href="ItemNotFoundError.html">ItemNotFoundError</a></div><div class="sidebar-section-children"><a href="ObjectNotFound.html">ObjectNotFound</a></div><div class="sidebar-section-children"><a href="QueryError.html">QueryError</a></div><div class="sidebar-section-children"><a href="TenantContext.html">TenantContext</a></div><div class="sidebar-section-children"><a href="ValidationError.html">ValidationError</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>