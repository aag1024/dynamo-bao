<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link type="text/css" rel="stylesheet" href="jsdoc.css"><title>Source: src/model.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><style>.gh-button-container{position:fixed;top:20px;right:200px;z-index:100}</style><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">DynamoBao</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-01-model-definitions.html">Model Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-02-query-and-filter.html">Querying and Filtering</a></div><div class="sidebar-section-children"><a href="tutorial-04-changing-models.html">Modifying Models</a></div><div class="sidebar-section-children"><a href="tutorial-05-ttl-fields.html">Time-to-live (TTL) Fields</a></div><div class="sidebar-section-children"><a href="tutorial-06-custom-fields.html">Custom Fields</a></div><div class="sidebar-section-children"><a href="tutorial-07-command-line-tools.html">Command Line Tools</a></div><div class="sidebar-section-children"><a href="tutorial-08-multi-tenancy.html">Multi-Tenancy</a></div><div class="sidebar-section-children"><a href="tutorial-09-cloudflare-workers.html">Cloudflare Workers</a></div><div class="sidebar-section-children"><a href="tutorial-10-batch-context-configuration.html">Batch Context Configuration</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoFields.html">BaoFields</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoError.html">BaoError</a></div><div class="sidebar-section-children"><a href="BaoFields.BaoBaseField.html">BaoBaseField</a></div><div class="sidebar-section-children"><a href="BaoFields.BinaryField.html">BinaryField</a></div><div class="sidebar-section-children"><a href="BaoFields.BooleanField.html">BooleanField</a></div><div class="sidebar-section-children"><a href="BaoFields.CounterField.html">CounterField</a></div><div class="sidebar-section-children"><a href="BaoFields.CreateDateField.html">CreateDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.DateTimeField.html">DateTimeField</a></div><div class="sidebar-section-children"><a href="BaoFields.FloatField.html">FloatField</a></div><div class="sidebar-section-children"><a href="BaoFields.IntegerField.html">IntegerField</a></div><div class="sidebar-section-children"><a href="BaoFields.ModifiedDateField.html">ModifiedDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.RelatedField.html">RelatedField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringField.html">StringField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringSetField.html">StringSetField</a></div><div class="sidebar-section-children"><a href="BaoFields.TtlField.html">TtlField</a></div><div class="sidebar-section-children"><a href="BaoFields.UlidField.html">UlidField</a></div><div class="sidebar-section-children"><a href="BaoFields.VersionField.html">VersionField</a></div><div class="sidebar-section-children"><a href="BaoModel.html">BaoModel</a></div><div class="sidebar-section-children"><a href="ConditionalError.html">ConditionalError</a></div><div class="sidebar-section-children"><a href="ConfigurationError.html">ConfigurationError</a></div><div class="sidebar-section-children"><a href="DataFormatError.html">DataFormatError</a></div><div class="sidebar-section-children"><a href="FilterExpressionBuilder.html">FilterExpressionBuilder</a></div><div class="sidebar-section-children"><a href="ItemNotFoundError.html">ItemNotFoundError</a></div><div class="sidebar-section-children"><a href="ObjectNotFound.html">ObjectNotFound</a></div><div class="sidebar-section-children"><a href="QueryError.html">QueryError</a></div><div class="sidebar-section-children"><a href="TenantContext.html">TenantContext</a></div><div class="sidebar-section-children"><a href="ValidationError.html">ValidationError</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="https://github.com/aag1024/dynamo-bao" target="_blank">ðŸ”— Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/dynamo-bao" target="_blank">ðŸ“¦ NPM</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">src_model.js</h1></header><article><pre class="prettyprint source lang-js"><code>/**
 * @description
 * This module contains the core functionality for models in Bao.
 */

const {
  RelatedFieldClass,
  StringField,
  StringSetFieldClass,
} = require("./fields");
const { ModelManager } = require("./model-manager");
const { defaultLogger: logger } = require("./utils/logger");
const { ObjectNotFound } = require("./object-not-found");
const ValidationMethods = require("./mixins/validation-mixin");
const UniqueConstraintMethods = require("./mixins/unique-constraint-mixin");
const QueryMethods = require("./mixins/query-mixin");
const MutationMethods = require("./mixins/mutation-mixin");
const {
  BatchLoadingMethods,
  BATCH_REQUESTS,
  BATCH_REQUEST_TIMEOUT,
} = require("./mixins/batch-loading-mixin");

const {
  PrimaryKeyConfig: PrimaryKeyConfigClass,
  IndexConfig: IndexConfigClass,
  UniqueConstraintConfig: UniqueConstraintConfigClass,
} = require("./model-config");

const GID_SEPARATOR = "##__SK__##";
const {
  UNIQUE_CONSTRAINT_KEY,
  SYSTEM_FIELDS,
  ITERATION_INDEX_NAME,
  ITERATION_PK_FIELD,
  ITERATION_SK_FIELD,
} = require("./constants");
const {
  ConfigurationError,
  ValidationError,
  QueryError,
  DataFormatError,
} = require("./exceptions");

/**
 * @description
 * Base model that implements core functionality for all models. Do not instantiate
 * this class directly, instead use a subclass, usually that has been generated
 * by the code generator.
 */
class BaoModel {
  static _tenantId = null;
  static _testId = null; // Backward compatibility
  static table = null;
  static documentClient = null;

  // These should be overridden by child classes
  static modelPrefix = null;
  static fields = {};
  static primaryKey = null;
  static indexes = {};
  static uniqueConstraints = {};
  static iterable = false;
  static iterationBuckets = 100;

  static defaultQueryLimit = 100;

  static {
    // Initialize methods
    Object.assign(BaoModel, ValidationMethods);
    Object.assign(BaoModel, UniqueConstraintMethods);
    Object.assign(BaoModel, QueryMethods);
    Object.assign(BaoModel, MutationMethods);
    Object.assign(BaoModel, BatchLoadingMethods);
  }

  /**
   * @description
   * ONLY use this for testing. It allows tests to run in isolation and
   * prevent data from being shared between tests/tests to run in parallel.
   * However, it should not be used outside of this context. For examples,
   * showing how to use this, see the tests.
   *
   * @deprecated Use TenantContext.setCurrentTenant() with the new multi-tenancy
   * system for both testing and production tenant isolation. See tutorial 08-multi-tenancy.
   * @param {string} testId - The ID of the test.
   */
  static setTestId(testId) {
    this._tenantId = testId;
    this._testId = testId; // Backward compatibility
    const manager = ModelManager.getInstance(testId);
    this.documentClient = manager.documentClient;
    this.table = manager.tableName;
  }

  static get manager() {
    const { TenantContext } = require("./tenant-context");
    const tenantId = TenantContext.getCurrentTenant();
    return ModelManager.getInstance(tenantId || this._tenantId);
  }

  static _getField(fieldName) {
    let fieldDef;
    if (SYSTEM_FIELDS.includes(fieldName) || fieldName === "modelPrefix") {
      fieldDef = StringField();
    } else {
      fieldDef = this.fields[fieldName];
    }

    if (!fieldDef) {
      throw new ConfigurationError(
        `Field ${fieldName} not found in ${this.name} fields`,
        this.name,
      );
    }

    return fieldDef;
  }

  static _getPkValue(data) {
    if (!data) {
      throw new ValidationError(
        "Data object is required for static _getPkValue call",
      );
    }

    const pkValue =
      this.primaryKey.pk === "modelPrefix"
        ? this.modelPrefix
        : data[this.primaryKey.pk];

    logger.debug("_getPkValue", pkValue);

    return pkValue;
  }

  static _getSkValue(data) {
    if (!data) {
      throw new ValidationError(
        "Data object is required for static _getSkValue call",
      );
    }

    if (this.primaryKey.sk === "modelPrefix") {
      return this.modelPrefix;
    }
    return data[this.primaryKey.sk];
  }

  _getPkValue() {
    return this.constructor._getPkValue(this._dyData);
  }

  _getSkValue() {
    return this.constructor._getSkValue(this._dyData);
  }

  static _formatGsiKey(modelPrefix, indexId, value) {
    const tenantId = this.manager.getTenantId();
    const baseKey = `${modelPrefix}#${indexId}#${value}`;
    return tenantId ? `[${tenantId}]#${baseKey}` : baseKey;
  }

  static _formatPrimaryKey(modelPrefix, value) {
    const tenantId = this.manager.getTenantId();
    const baseKey = `${modelPrefix}#${value}`;
    return tenantId ? `[${tenantId}]#${baseKey}` : baseKey;
  }

  static _formatUniqueConstraintKey(constraintId, modelPrefix, field, value) {
    const tenantId = this.manager.getTenantId();
    const baseKey = `${UNIQUE_CONSTRAINT_KEY}#${constraintId}#${modelPrefix}#${field}:${value}`;
    return tenantId ? `[${tenantId}]#${baseKey}` : baseKey;
  }

  static _getDyKeyForPkSk(pkSk) {
    if (this.primaryKey.sk === "modelPrefix") {
      return {
        _pk: this._formatPrimaryKey(this.modelPrefix, pkSk.pk),
        _sk: this.modelPrefix,
      };
    } else if (this.primaryKey.pk === "modelPrefix") {
      return {
        _pk: this.modelPrefix,
        _sk: pkSk.sk,
      };
    } else {
      return {
        _pk: this._formatPrimaryKey(this.modelPrefix, pkSk.pk),
        _sk: pkSk.sk,
      };
    }
  }

  static _getIterationKeys(objectId, dyData) {
    if (!this.iterable) {
      return {};
    }

    const tenantId = this.manager.getTenantId();
    let iterPk;

    if (this.iterationBuckets === 1) {
      iterPk = tenantId
        ? `[${tenantId}]#${this.modelPrefix}#iter`
        : `${this.modelPrefix}#iter`;
    } else {
      const bucketNum = this._hashObjectId(objectId) % this.iterationBuckets;
      const bucket = bucketNum.toString().padStart(3, "0");
      iterPk = tenantId
        ? `[${tenantId}]#${this.modelPrefix}#iter#${bucket}`
        : `${this.modelPrefix}#iter#${bucket}`;
    }

    return {
      [ITERATION_PK_FIELD]: iterPk,
      [ITERATION_SK_FIELD]: objectId,
    };
  }

  static _hashObjectId(objectId) {
    let hash = 0;
    for (let i = 0; i &lt; objectId.length; i++) {
      const char = objectId.charCodeAt(i);
      hash = (hash &lt;&lt; 5) - hash + char;
      hash = hash &amp; hash;
    }
    return Math.abs(hash);
  }

  static getIterationBuckets() {
    return this.iterable ? this.iterationBuckets : 1;
  }

  static async *iterateAll(options = {}) {
    if (!this.iterable) {
      throw new Error(`Model ${this.name} is not configured as iterable`);
    }

    const { batchSize = 100, filter = null } = options;

    if (this.iterationBuckets === 1) {
      yield* this._iterateSingleBucket(null, {
        batchSize,
        filter,
      });
    } else {
      for (let bucket = 0; bucket &lt; this.iterationBuckets; bucket++) {
        yield* this._iterateSingleBucket(bucket, {
          batchSize,
          filter,
        });
      }
    }
  }

  static async *iterateBucket(bucketNum, options = {}) {
    if (!this.iterable) {
      throw new Error(`Model ${this.name} is not configured as iterable`);
    }

    if (bucketNum &lt; 0 || bucketNum >= this.iterationBuckets) {
      throw new Error(
        `Invalid bucket number ${bucketNum}. Must be 0-${this.iterationBuckets - 1}`,
      );
    }

    yield* this._iterateSingleBucket(bucketNum, options);
  }

  static async *_iterateSingleBucket(bucketNum, options = {}) {
    const { batchSize = 100, filter = null } = options;
    const tenantId = this.manager.getTenantId();

    let iterPk;
    if (this.iterationBuckets === 1) {
      iterPk = tenantId
        ? `[${tenantId}]#${this.modelPrefix}#iter`
        : `${this.modelPrefix}#iter`;
    } else {
      const bucket = bucketNum.toString().padStart(3, "0");
      iterPk = tenantId
        ? `[${tenantId}]#${this.modelPrefix}#iter#${bucket}`
        : `${this.modelPrefix}#iter#${bucket}`;
    }

    let lastEvaluatedKey = null;

    do {
      const { QueryCommand } = require("./dynamodb-client");
      const params = {
        TableName: this.table,
        IndexName: ITERATION_INDEX_NAME,
        KeyConditionExpression: "#pk = :pk",
        ExpressionAttributeNames: { "#pk": ITERATION_PK_FIELD },
        ExpressionAttributeValues: { ":pk": iterPk },
        Limit: batchSize,
        ReturnConsumedCapacity: "TOTAL",
      };

      if (lastEvaluatedKey) {
        params.ExclusiveStartKey = lastEvaluatedKey;
      }

      if (filter) {
        const { FilterExpressionBuilder } = require("./filter-expression");
        const filterBuilder = new FilterExpressionBuilder();
        const filterExpression = filterBuilder.build(filter, this);
        if (filterExpression) {
          params.FilterExpression = filterExpression.FilterExpression;
          Object.assign(
            params.ExpressionAttributeNames,
            filterExpression.ExpressionAttributeNames,
          );
          Object.assign(
            params.ExpressionAttributeValues,
            filterExpression.ExpressionAttributeValues,
          );
        }
      }

      const response = await this.documentClient.send(new QueryCommand(params));

      if (response.Items &amp;&amp; response.Items.length > 0) {
        const objectIds = response.Items.map(
          (item) => item[ITERATION_SK_FIELD],
        );

        const { items } = await this.batchFind(objectIds);
        const batch = Object.values(items);

        if (batch.length > 0) {
          yield batch;
        }
      }

      lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
  }

  /**
   * @description
   * Create a new model instance.
   * @param {Object} [jsData] - The initial data for the model.
   */
  constructor(jsData = {}) {
    this._dyData = {};
    SYSTEM_FIELDS.forEach((key) => {
      if (jsData[key] !== undefined) {
        this._dyData[key] = jsData[key];
      }
    });

    this._loadedDyData = {};
    this._changes = new Set();
    this._relatedObjects = {};
    this._consumedCapacity = [];

    // Initialize fields with data
    Object.entries(this.constructor.fields).forEach(([fieldName, field]) => {
      // Convert initial value to DynamoDB format
      let value =
        jsData[fieldName] === undefined
          ? field.getInitialValue()
          : jsData[fieldName];
      this._dyData[fieldName] = field.toDy(value);

      // Define property getter/setter that always works with _dyData
      Object.defineProperty(this, fieldName, {
        get: () => {
          // For StringSetField, pass model context to enable proxy
          if (field instanceof StringSetFieldClass) {
            return field.fromDy(this._dyData[fieldName], this, fieldName);
          }
          return field.fromDy(this._dyData[fieldName]);
        },
        set: (newValue) => {
          const oldDyValue = this._dyData[fieldName];
          const newDyValue = field.toDy(newValue);
          if (newDyValue !== oldDyValue) {
            this._dyData[fieldName] = newDyValue;
            this._changes.add(fieldName);
            if (field instanceof RelatedFieldClass) {
              delete this._relatedObjects[fieldName];
            }
          }
        },
      });
    });
  }

  static _createFromDyItem(dyItem) {
    const newObj = new this();
    newObj._dyData = dyItem;
    newObj._resetChangeTracking();

    logger.debug("_createFromDyItem", dyItem, newObj);
    logger.debug("_createFromDyItem.name", newObj.name);
    return newObj;
  }

  /**
   * @description
   * Clear the related cache for a given field.
   * @param {string} fieldName - The name of the field to clear.
   */
  clearRelatedCache(fieldName) {
    delete this._relatedObjects[fieldName];
  }

  // Returns the pk and sk values for a given object. These are encoded to work with
  // dynamo string keys. No test prefix or model prefix is applied.
  static _getPrimaryKeyValues(data) {
    if (!data) {
      throw new ValidationError(
        "Data object is required for _getPrimaryKeyValues call",
      );
    }

    const pkField = this._getField(this.primaryKey.pk);
    const pkValue = pkField
      ? pkField.toGsi(this._getPkValue(data))
      : this._getPkValue(data);

    if (pkValue === undefined || pkValue === null) {
      throw new ValidationError(`PK must be defined to get a PkSk`);
    }

    const key = { pk: pkValue };

    if (this.primaryKey.sk) {
      const skField = this._getField(this.primaryKey.sk);
      const skValue = skField
        ? skField.toGsi(this._getSkValue(data))
        : this._getSkValue(data);

      if (skValue === undefined || skValue === null) {
        throw new ValidationError(
          `SK must be defined for a composite primary key`,
        );
      }
      key.sk = skValue;
    }

    logger.debug("_getPrimaryKeyValues", key);
    return key;
  }

  /**
   * @description
   * Make a primary ID from a pk and sk.
   * @param {string} pk - The partition key.
   * @param {string} sk - The sort key.
   * @returns {string} The primary ID.
   */
  static makePrimaryId(pk, sk) {
    if (this.primaryKey.pk === "modelPrefix") {
      return sk;
    } else if (this.primaryKey.sk === "modelPrefix") {
      return pk;
    } else {
      return pk + GID_SEPARATOR + sk;
    }
  }

  /**
   * @description
   * Static version of {@link BaoModel#getPrimaryId}.
   * @param {Object} data - The data object to get the primary ID for.
   * @returns {string} The primary ID.
   */
  static getPrimaryId(data) {
    logger.debug("getPrimaryId", data);
    const pkSk = this._getPrimaryKeyValues(data);
    logger.debug("getPrimaryId", pkSk);

    let primaryId = this.makePrimaryId(pkSk.pk, pkSk.sk);
    return primaryId;
  }

  /**
   * @description
   * Get the primary ID for a given object. This is a string that uniquely
   * identifies the object in the database. When using {@link BaoModel.find},
   * this is the id to use. Do not make assumptions about how this id
   * is formatted since it will depend on the model key structure.
   * @returns {string} The primary ID.
   */
  getPrimaryId() {
    return this.constructor.getPrimaryId(this._dyData);
  }

  static _parsePrimaryId(primaryId) {
    if (typeof primaryId === "object" &amp;&amp; primaryId !== null) {
      if (primaryId.pk !== undefined) {
        return primaryId;
      }
      return this._getPrimaryKeyValues(primaryId);
    }

    if (typeof primaryId !== "string") {
      throw new ValidationError(
        `primaryId must be a string or an object. Got ${typeof primaryId}`,
      );
    }

    if (primaryId.indexOf(GID_SEPARATOR) !== -1) {
      const [pk, sk] = primaryId.split(GID_SEPARATOR);
      return { pk, sk };
    } else {
      if (this.primaryKey.pk === "modelPrefix") {
        return { pk: this.modelPrefix, sk: primaryId };
      } else if (this.primaryKey.sk === "modelPrefix") {
        return { pk: primaryId, sk: this.modelPrefix };
      }
      return { pk: primaryId };
    }
  }

  // Get all data - convert from Dynamo to JS format
  _getAllData() {
    const allData = {};
    for (const [fieldName, field] of Object.entries(this.constructor.fields)) {
      allData[fieldName] = field.fromDy(this._dyData[fieldName]);
    }
    return allData;
  }

  // Get only changed fields - convert from Dynamo to JS format
  _getChanges() {
    const changes = {};
    logger.debug("_changes Set contains:", Array.from(this._changes));
    for (const field of this._changes) {
      const fieldDef = this.constructor._getField(field);
      logger.debug("Field definition for", field, ":", {
        type: fieldDef.constructor.name,
        field: fieldDef,
      });
      const dyValue = this._dyData[field];
      logger.debug("Converting value:", {
        field,
        dyValue,
        fromDyExists: typeof fieldDef.fromDy === "function",
      });
      changes[field] = fieldDef.fromDy(dyValue);
    }
    return changes;
  }

  /**
   * @description
   * Returns true if any fields have been modified since the object was last
   * loaded from the database.
   * @returns {boolean} True if there are changes, false otherwise.
   */
  hasChanges() {
    return this._changes.size > 0;
  }

  /**
   * @description
   * Returns true if the object has been loaded from the database.
   * @returns {boolean} True if the object has been loaded, false otherwise.
   */
  isLoaded() {
    return Object.keys(this._loadedDyData).length > 0;
  }

  // Reset tracking after successful save
  _resetChangeTracking() {
    this._loadedDyData = { ...this._dyData };
    this._changes.clear();
  }

  /**
   * @description
   * Save the current object to the database. This operation will diff the current
   * state of the object with the state that has been loaded from dynamo to
   * determine which changes need to be saved.
   *
   * @param {Object} [options] - Additional options for the save operation.
   * @param {Object} [options.constraints={}] - Constraints to validate. Options are:
   * @param {boolean} [options.constraints.mustExist=false] - Whether the item must exist.
   * @param {boolean} [options.constraints.mustNotExist=false] - Whether the item must not exist.
   * @param {string[]} [options.constraints.fieldMatches=[]] - An array of field names that must match
   * the current item's loaded state. This is often used for optimistic locking in conjunction
   * with a {@link BaoFields.VersionField} field.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the updated item.
   */
  async save(options = {}) {
    if (!this.hasChanges() &amp;&amp; this.isLoaded()) {
      logger.debug("save() - no changes to save");
      return this; // No changes to save
    }

    let changes = null;
    if (!this.isLoaded()) {
      options.isNew = true;
      changes = this._getAllData();
    } else {
      changes = this._getChanges();
    }

    logger.debug("save() - changes", changes);
    const updatedObj = await this.constructor.update(
      this.getPrimaryId(),
      changes,
      { instanceObj: this, ...options },
    );

    logger.debug("save() - updatedObj", updatedObj);
    this._dyData = updatedObj._dyData;
    logger.debug("save() - this", this);

    // Reset change tracking after successful save
    this._resetChangeTracking();

    return this;
  }

  /**
   * @description
   * Get or load a related field. If the field is already loaded, it will be
   * returned without reloading. Otherwise, it will be loaded from the database
   * and returned.
   * @param {string} fieldName - The name of the field to get or load.
   * @param {Object} [loaderContext] - Cache context for storing and retrieving items across requests.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the loaded item.
   */
  async getOrLoadRelatedField(fieldName) {
    if (this._relatedObjects[fieldName]) {
      return this._relatedObjects[fieldName];
    }

    const field = this.constructor.fields[fieldName];
    if (!field || !field.modelName) {
      throw new ConfigurationError(
        `Field ${fieldName} is not a valid relation field`,
        this.constructor.name,
      );
    }

    const value = this[fieldName];
    if (!value) return null;

    const ModelClass = this.constructor.manager.getModel(field.modelName);
    this._relatedObjects[fieldName] = await ModelClass.find(value);
    return this._relatedObjects[fieldName];
  }

  /**
   * @description
   * Load objects for RelatedField's on the current model instance.
   * @param {string[]} [fieldNames] - The names of the fields to load. If not provided, all related fields will be loaded.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the loaded items and their consumed capacity
   */
  async loadRelatedData(fieldNames = null) {
    const promises = [];

    for (const [fieldName, field] of Object.entries(this.constructor.fields)) {
      if (fieldNames &amp;&amp; !fieldNames.includes(fieldName)) {
        continue;
      }

      if (field instanceof RelatedFieldClass &amp;&amp; this[fieldName]) {
        promises.push(
          this._loadRelatedField(fieldName, field).then((instance) => {
            this._relatedObjects[fieldName] = instance;
          }),
        );
      }
    }

    await Promise.all(promises);
    return this;
  }

  async _loadRelatedField(fieldName, field) {
    const value = this[fieldName];
    if (!value) return null;

    const ModelClass = this.constructor.manager.getModel(field.modelName);

    if (value instanceof ModelClass) {
      return value;
    }

    // Load the instance and track its capacity
    const relatedInstance = await ModelClass.find(value);

    return relatedInstance;
  }

  /**
   * @description
   * Get a related field. If the field is not loaded, it will return null.
   * @param {string} fieldName - The name of the field to get.
   * @returns {Object} The related field.
   */
  getRelated(fieldName) {
    const field = this.constructor.fields[fieldName];
    if (!(field instanceof RelatedFieldClass)) {
      throw new ConfigurationError(
        `Field ${fieldName} is not a RelatedField`,
        this.constructor.name,
      );
    }
    return this._relatedObjects[fieldName];
  }

  /**
   * @description
   * Find an object by a unique constraint. Any unique constraint can also be used
   * to find an object.
   * @param {string} constraintName - The name of the unique constraint to use.
   * @param {string} value - The value of the unique constraint.
   * @returns {Promise&lt;Object>} Returns a promise that resolves to the found item.
   */
  static async findByUniqueConstraint(constraintName, value) {
    const constraint = this.uniqueConstraints[constraintName];
    if (!constraint) {
      throw new ConfigurationError(
        `Unknown unique constraint '${constraintName}' in ${this.name}`,
        this.name,
      );
    }

    if (!value) {
      throw new ValidationError(
        `${constraint.field} value is required`,
        constraint.field,
      );
    }

    const key = this._formatUniqueConstraintKey(
      constraint.constraintId,
      this.modelPrefix,
      constraint.field,
      value,
    );

    const { GetCommand } = require("./dynamodb-client");
    const result = await this.documentClient.send(
      new GetCommand({
        TableName: this.table,
        Key: {
          _pk: key,
          _sk: UNIQUE_CONSTRAINT_KEY,
        },
        ReturnConsumedCapacity: "TOTAL",
      }),
    );

    if (!result.Item) {
      return new ObjectNotFound(result.ConsumedCapacity);
    }

    const item = await this.find(result.Item.relatedId);

    if (item.exists()) {
      item._addConsumedCapacity(result.ConsumedCapacity, "read");
    }

    return item;
  }

  /**
   * @description
   * Returns true if the object exists. This is particularly useful when checking
   * if an object has been found, since ObjectNotFound will be returned
   * rather than null if an object is not found (so capacity information
   * will also be returned).
   * @returns {boolean} True if the object exists, false otherwise.
   */
  exists() {
    return true;
  }

  _setConsumedCapacity(capacity, type = "read", fromContext = false) {
    this.clearConsumedCapacity();
    this._addConsumedCapacity(capacity, type, fromContext);
  }

  _addConsumedCapacity(consumedCapacity, type, isRelated = false) {
    if (!["read", "write"].includes(type)) {
      throw new ValidationError(`Invalid consumed capacity type: ${type}`);
    }

    if (!consumedCapacity) {
      return;
    }

    if (Array.isArray(consumedCapacity)) {
      consumedCapacity.forEach((item) =>
        this._addConsumedCapacity(item, type, isRelated),
      );
    } else {
      if (consumedCapacity.consumedCapacity) {
        this._consumedCapacity.push({
          consumedCapacity: consumedCapacity.consumedCapacity,
          fromContext: consumedCapacity.fromContext || isRelated,
          type: consumedCapacity.type || type,
        });
      } else {
        this._consumedCapacity.push({
          consumedCapacity: consumedCapacity,
          fromContext: isRelated,
          type: type,
        });
      }
    }
  }

  /**
   * Get the number of RCU/WCU consumed by a model instance. Additional capacity
   * is added every time a new operation (finding, saving, loading related data)
   * is performed on the instance. You can reset the consumed capacity by calling
   * {@link BaoModel#clearConsumedCapacity}.
   * @param {string} type - Either "read", "write", or "total".
   * @param {boolean} [includeRelated=false] - Whether to include capacity from related objects.
   * @returns {number} The numeric consumed capacity.
   */
  getNumericConsumedCapacity(type, includeRelated = false) {
    if (!["read", "write", "total"].includes(type)) {
      throw new ValidationError(`Invalid consumed capacity type: ${type}`);
    }

    let consumedCapacity = this._consumedCapacity;
    if (!consumedCapacity) {
      consumedCapacity = [];
    }

    let total = consumedCapacity.reduce((sum, capacity) => {
      if (
        !capacity.fromContext &amp;&amp;
        (capacity.type === type || type === "total")
      ) {
        return sum + (capacity.consumedCapacity?.CapacityUnits || 0);
      }
      return sum;
    }, 0);

    if (includeRelated) {
      // Sum up capacity from any loaded related objects
      for (const relatedObj of Object.values(this._relatedObjects)) {
        if (relatedObj) {
          const relatedCapacity = relatedObj.getNumericConsumedCapacity(
            type,
            true,
          );
          total += relatedCapacity;
        }
      }
    }

    return total;
  }

  /**
   * @description
   * Get the consumed capacity for the current model instance. Every entry
   * in this array will represent a separate operation.
   * @returns {Object[]} The consumed capacity.
   */
  getConsumedCapacity() {
    return this._consumedCapacity;
  }

  /**
   * @description
   * Clear the consumed capacity for the current model instance.
   */
  clearConsumedCapacity() {
    this._consumedCapacity = [];
  }
}

// Factory functions to maintain compatibility
const PrimaryKeyConfig = (pk, sk) => new PrimaryKeyConfigClass(pk, sk);
const IndexConfig = (pk, sk, indexId) => new IndexConfigClass(pk, sk, indexId);
const UniqueConstraintConfig = (field, constraintId) =>
  new UniqueConstraintConfigClass(field, constraintId);

module.exports = {
  BaoModel,
  PrimaryKeyConfig,
  IndexConfig,
  UniqueConstraintConfig,
  BATCH_REQUEST_TIMEOUT,
  BATCH_REQUESTS,
};
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">DynamoBao</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="https://github.com/aag1024/dynamo-bao" target="_blank">ðŸ”— Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/dynamo-bao" target="_blank">ðŸ“¦ NPM</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-01-model-definitions.html">Model Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-02-query-and-filter.html">Querying and Filtering</a></div><div class="sidebar-section-children"><a href="tutorial-04-changing-models.html">Modifying Models</a></div><div class="sidebar-section-children"><a href="tutorial-05-ttl-fields.html">Time-to-live (TTL) Fields</a></div><div class="sidebar-section-children"><a href="tutorial-06-custom-fields.html">Custom Fields</a></div><div class="sidebar-section-children"><a href="tutorial-07-command-line-tools.html">Command Line Tools</a></div><div class="sidebar-section-children"><a href="tutorial-08-multi-tenancy.html">Multi-Tenancy</a></div><div class="sidebar-section-children"><a href="tutorial-09-cloudflare-workers.html">Cloudflare Workers</a></div><div class="sidebar-section-children"><a href="tutorial-10-batch-context-configuration.html">Batch Context Configuration</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-namespaces"><div>Namespaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoFields.html">BaoFields</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaoError.html">BaoError</a></div><div class="sidebar-section-children"><a href="BaoFields.BaoBaseField.html">BaoBaseField</a></div><div class="sidebar-section-children"><a href="BaoFields.BinaryField.html">BinaryField</a></div><div class="sidebar-section-children"><a href="BaoFields.BooleanField.html">BooleanField</a></div><div class="sidebar-section-children"><a href="BaoFields.CounterField.html">CounterField</a></div><div class="sidebar-section-children"><a href="BaoFields.CreateDateField.html">CreateDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.DateTimeField.html">DateTimeField</a></div><div class="sidebar-section-children"><a href="BaoFields.FloatField.html">FloatField</a></div><div class="sidebar-section-children"><a href="BaoFields.IntegerField.html">IntegerField</a></div><div class="sidebar-section-children"><a href="BaoFields.ModifiedDateField.html">ModifiedDateField</a></div><div class="sidebar-section-children"><a href="BaoFields.RelatedField.html">RelatedField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringField.html">StringField</a></div><div class="sidebar-section-children"><a href="BaoFields.StringSetField.html">StringSetField</a></div><div class="sidebar-section-children"><a href="BaoFields.TtlField.html">TtlField</a></div><div class="sidebar-section-children"><a href="BaoFields.UlidField.html">UlidField</a></div><div class="sidebar-section-children"><a href="BaoFields.VersionField.html">VersionField</a></div><div class="sidebar-section-children"><a href="BaoModel.html">BaoModel</a></div><div class="sidebar-section-children"><a href="ConditionalError.html">ConditionalError</a></div><div class="sidebar-section-children"><a href="ConfigurationError.html">ConfigurationError</a></div><div class="sidebar-section-children"><a href="DataFormatError.html">DataFormatError</a></div><div class="sidebar-section-children"><a href="FilterExpressionBuilder.html">FilterExpressionBuilder</a></div><div class="sidebar-section-children"><a href="ItemNotFoundError.html">ItemNotFoundError</a></div><div class="sidebar-section-children"><a href="ObjectNotFound.html">ObjectNotFound</a></div><div class="sidebar-section-children"><a href="QueryError.html">QueryError</a></div><div class="sidebar-section-children"><a href="TenantContext.html">TenantContext</a></div><div class="sidebar-section-children"><a href="ValidationError.html">ValidationError</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>